# Check what is the percentage of total revenue in the matched data and in 
# the order database, group the results by city, sort in the descending order.

from data_integration import master_db,order_db
from soundex import soundex
from pythonql.helpers import print_table

res = [
  select city, order_sum
  for m in master_db,
      o in order_db
  where soundex(m.first_name) == soundex(o.first_name) and
        soundex(m.last_name) == soundex(m.last_name) and
        any([ select c_addr.city == o.store.address.city
              for c_addr in m.addresses ])
  let orig = try Decimal(order_db.amount) except None,
            quantized = try Decimal(order_db.amount).quantize(Decimal('1.00')) except None
  where (orig and quantized) and orig == quantized
  group by o.store.address.city as city
  let order_sum = sum(quantized)
  order by order_sum desc ]

print_table(res)
